#!/bin/sh
#
# Pre-commit hook: Block commits containing hardcoded secrets.
# Install: git config core.hooksPath .githooks
#
# This hook scans staged files for patterns that look like
# hardcoded credentials and blocks the commit if found.

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}üîí Security: Scanning staged files for secrets...${NC}"

# Get list of staged files (excluding deletions and binary files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py|ts|tsx|js|jsx|json|yml|yaml|toml|cfg|ini|env\.example)$')

if [ -z "$STAGED_FILES" ]; then
    echo "${GREEN}‚úÖ No text files staged. Skipping secret scan.${NC}"
    exit 0
fi

FOUND_SECRETS=0

# Pattern 1: MongoDB connection strings with embedded passwords
if echo "$STAGED_FILES" | xargs grep -lnE 'mongodb\+srv://[^:]+:[^@]+@' 2>/dev/null; then
    echo "${RED}üö® BLOCKED: MongoDB connection string with embedded password found!${NC}"
    echo "   Use: os.environ.get('MONGO_URL') instead."
    FOUND_SECRETS=1
fi

# Pattern 2: Hardcoded passwords (password = "..." or password: "...")
if echo "$STAGED_FILES" | xargs grep -lnE '(password|passwd|pwd)\s*[=:]\s*["\x27][A-Za-z0-9!@#$%^&*_.]{4,}["\x27]' 2>/dev/null | grep -v 'node_modules' | grep -v '.lock'; then
    echo "${RED}üö® BLOCKED: Hardcoded password detected!${NC}"
    echo "   Use environment variables for all passwords."
    FOUND_SECRETS=1
fi

# Pattern 3: API keys/tokens that look real (long alphanumeric strings)
if echo "$STAGED_FILES" | xargs grep -lnE '(api_key|apikey|api_token|access_token|secret_key|access_secret)\s*[=:]\s*["\x27][a-zA-Z0-9_\-]{20,}["\x27]' 2>/dev/null | grep -v 'node_modules' | grep -v '.lock' | grep -v 'placeholder'; then
    echo "${RED}üö® BLOCKED: Hardcoded API key/token detected!${NC}"
    echo "   Use environment variables for all API keys."
    FOUND_SECRETS=1
fi

# Pattern 4: Private keys
if echo "$STAGED_FILES" | xargs grep -lnE 'BEGIN (RSA |EC |OPENSSH |DSA )?PRIVATE KEY' 2>/dev/null; then
    echo "${RED}üö® BLOCKED: Private key file detected!${NC}"
    echo "   Never commit private keys. Add to .gitignore."
    FOUND_SECRETS=1
fi

# Pattern 5: AWS keys
if echo "$STAGED_FILES" | xargs grep -lnE 'AKIA[0-9A-Z]{16}' 2>/dev/null; then
    echo "${RED}üö® BLOCKED: AWS Access Key detected!${NC}"
    FOUND_SECRETS=1
fi

# Pattern 6: .env files being committed
if git diff --cached --name-only | grep -E '^\.env$|/\.env$'; then
    echo "${RED}üö® BLOCKED: .env file is being committed!${NC}"
    echo "   Add .env to .gitignore."
    FOUND_SECRETS=1
fi

if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo "${RED}‚ùå Commit BLOCKED. Remove hardcoded secrets before committing.${NC}"
    echo "${YELLOW}   Tip: Use 'git diff --cached' to review staged changes.${NC}"
    echo "${YELLOW}   To bypass (EMERGENCY ONLY): git commit --no-verify${NC}"
    exit 1
fi

echo "${GREEN}‚úÖ No secrets detected. Commit allowed.${NC}"
exit 0
