generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE SYSTEM MODELS
// ============================================

enum UserRole {
  OWNER
  MANAGER
  SERVER
  KITCHEN
  HOST
}

enum VenueType {
  FINE_DINING
  CASUAL
  QSR
  BAR
  CAFE
}

enum ServiceStyle {
  TABLE_SERVICE
  COUNTER_SERVICE
  BUFFET
  TAKEAWAY
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  CLEANING
}

enum OrderStatus {
  PENDING
  IN_PROGRESS
  READY
  COMPLETED
  CANCELLED
}

enum TicketStatus {
  NEW
  IN_PROGRESS
  READY
  COMPLETED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum DocumentType {
  INVOICE
  RECEIPT
  CONTRACT
  POLICY
  PROCEDURE
  OTHER
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================
// VENUES & ORGANIZATION
// ============================================

model Venue {
  id           String       @id @default(uuid())
  name         String
  type         VenueType    @default(CASUAL)
  serviceStyle ServiceStyle @default(TABLE_SERVICE)
  timezone     String       @default("Europe/Malta")
  address      String?
  phone        String?
  config       Json? // Flexible config: opening hours, tax rates, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  zones       Zone[]
  users       User[]
  menus       Menu[]
  orders      Order[]
  kdsTickets  KDSTicket[]
  inventory   InventoryItem[]
  documents   Document[]
  auditLogs   AuditLog[]
  shifts      Shift[]
  shiftPolicy VenueShiftPolicy?

  @@map("venues")
}

// ============================================
// USERS & AUTH
// ============================================

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  role      UserRole
  pinHash   String   @map("pin_hash")
  mfaSecret String?  @map("mfa_secret")

  venueId String @map("venue_id")
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Multi-venue access
  allowedVenueIds String[] @default([]) @map("allowed_venue_ids")
  defaultVenueId  String?  @map("default_venue_id")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  orders    Order[]
  auditLogs AuditLog[]
  shifts    Shift[]

  @@index([venueId])
  @@map("users")
}

// ============================================
// FLOOR PLAN & TABLES
// ============================================

model Zone {
  id      String @id @default(uuid())
  name    String
  venueId String @map("venue_id")
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  // Relations
  tables Table[]

  @@index([venueId])
  @@map("zones")
}

model Table {
  id     String      @id @default(uuid())
  name   String
  seats  Int         @default(4)
  status TableStatus @default(AVAILABLE)

  zoneId String @map("zone_id")
  zone   Zone   @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  // Relations
  orders Order[]

  @@index([zoneId])
  @@map("tables")
}

// ============================================
// MENU DOMAIN
// ============================================

model Menu {
  id       String  @id @default(uuid())
  name     String
  isActive Boolean @default(true) @map("is_active")

  venueId String @map("venue_id")
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  categories MenuCategory[]

  @@index([venueId])
  @@map("menus")
}

model MenuCategory {
  id        String @id @default(uuid())
  name      String
  sortOrder Int    @default(0) @map("sort_order")

  menuId String @map("menu_id")
  menu   Menu   @relation(fields: [menuId], references: [id], onDelete: Cascade)

  // Relations
  items MenuItem[]

  @@index([menuId])
  @@map("menu_categories")
}

model MenuItem {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Float
  prepTime    Int      @default(10) @map("prep_time") // minutes
  allergens   String[] @default([])
  tags        String[] @default([]) // e.g., vegetarian, gluten-free, spicy

  categoryId String       @map("category_id")
  category   MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  isAvailable Boolean  @default(true) @map("is_available")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  orderItems OrderItem[]

  @@index([categoryId])
  @@map("menu_items")
}

// ============================================
// ORDERS & POS
// ============================================

model Order {
  id          String      @id @default(uuid())
  orderNumber String      @unique @map("order_number")
  status      OrderStatus @default(PENDING)

  venueId String @map("venue_id")
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  tableId String? @map("table_id")
  table   Table?  @relation(fields: [tableId], references: [id], onDelete: SetNull)

  serverId String? @map("server_id")
  server   User?   @relation(fields: [serverId], references: [id], onDelete: SetNull)

  subtotal Float @default(0)
  tax      Float @default(0)
  total    Float @default(0)

  notes String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  items      OrderItem[]
  kdsTickets KDSTicket[]

  @@index([venueId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id       String  @id @default(uuid())
  quantity Int     @default(1)
  price    Float
  notes    String?

  orderId String @map("order_id")
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  menuItemId String   @map("menu_item_id")
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

// ============================================
// KDS (Kitchen Display System)
// ============================================

model KDSTicket {
  id           String         @id @default(uuid())
  ticketNumber String         @unique @map("ticket_number")
  status       TicketStatus   @default(NEW)
  priority     TicketPriority @default(MEDIUM)
  station      String // e.g., "HOT", "COLD", "GRILL", "PASTRY"

  venueId String @map("venue_id")
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  orderId String @map("order_id")
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  items Json // Denormalized items for KDS display

  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([venueId])
  @@index([status])
  @@map("kds_tickets")
}

// ============================================
// INVENTORY MANAGEMENT
// ============================================

model InventoryItem {
  id       String @id @default(uuid())
  name     String
  category String
  unit     String @default("unit")
  quantity Float  @default(0)
  minStock Float  @default(0) @map("min_stock")

  venueId String @map("venue_id")
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  ledgerEntries StockLedger[]

  @@index([venueId])
  @@map("inventory_items")
}

model StockLedger {
  id       String  @id @default(uuid())
  type     String // "IN", "OUT", "ADJUST", "WASTE"
  quantity Float
  notes    String?

  itemId String        @map("item_id")
  item   InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([itemId])
  @@map("stock_ledger")
}

// ============================================
// DOCUMENT HUB
// ============================================

model Document {
  id       String       @id @default(uuid())
  title    String
  type     DocumentType
  filePath String?      @map("file_path")
  metadata Json? // OCR results, extracted text, etc.

  venueId String @map("venue_id")
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  uploadedAt  DateTime  @default(now()) @map("uploaded_at")
  processedAt DateTime? @map("processed_at")

  @@index([venueId])
  @@map("documents")
}

// ============================================
// REVIEW RISK CONTROL
// ============================================

model ReviewRisk {
  id        String    @id @default(uuid())
  platform  String // "google", "tripadvisor", "yelp"
  reviewId  String    @map("review_id")
  rating    Float
  content   String?
  riskLevel RiskLevel @map("risk_level")
  sentiment Float? // -1 to 1
  keywords  String[]  @default([])

  venueId String @map("venue_id")

  reviewDate DateTime @map("review_date")
  analyzedAt DateTime @default(now()) @map("analyzed_at")

  @@index([venueId])
  @@index([riskLevel])
  @@map("review_risks")
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model AuditLog {
  id       String @id @default(uuid())
  action   String
  entity   String
  entityId String @map("entity_id")
  changes  Json?

  venueId String @map("venue_id")
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  timestamp DateTime @default(now())

  @@index([venueId])
  @@index([entity, entityId])
  @@map("audit_logs")
}

// ============================================
// SHIFT MANAGEMENT & ACCESS CONTROL
// ============================================

model Shift {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  venueId String @map("venue_id")
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  startAt DateTime @map("start_at")
  endAt   DateTime @map("end_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([venueId])
  @@index([startAt, endAt])
  @@map("shifts")
}

model VenueShiftPolicy {
  id      String @id @default(uuid())
  venueId String @unique @map("venue_id")
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  enforceShiftLogin Boolean @default(true) @map("enforce_shift_login")
  graceBefore       Int     @default(15) // minutes before shift start
  graceAfter        Int     @default(30) // minutes after shift end
  autoLogout        Boolean @default(true) @map("auto_logout")

  allowManagerOverride   Boolean @default(true) @map("allow_manager_override")
  overrideDefaultMinutes Int     @default(15) @map("override_default_minutes")
  overrideMaxMinutes     Int     @default(30) @map("override_max_minutes")
  requireOverrideReason  Boolean @default(true) @map("require_override_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("venue_shift_policies")
}

model ShiftOverride {
  id      String @id @default(uuid())
  venueId String @map("venue_id")

  staffUserId     String @map("staff_user_id")
  grantedByUserId String @map("granted_by_user_id")

  reason    String?
  startsAt  DateTime @map("starts_at")
  expiresAt DateTime @map("expires_at")

  revokedAt       DateTime? @map("revoked_at")
  revokedByUserId String?   @map("revoked_by_user_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([staffUserId, venueId])
  @@index([startsAt, expiresAt])
  @@map("shift_overrides")
}

model AuthSession {
  id       String  @id @default(uuid())
  userId   String  @map("user_id")
  venueId  String  @map("venue_id")
  deviceId String? @map("device_id")
  app      String // admin, pos, kds

  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("auth_sessions")
}

model LoginAttempt {
  id        String  @id @default(uuid())
  username  String?
  pin       String? // last 2 digits for audit
  deviceId  String? @map("device_id")
  ipAddress String? @map("ip_address")

  app        String // admin, pos, kds
  success    Boolean
  failReason String? @map("fail_reason")

  userId  String? @map("user_id")
  venueId String? @map("venue_id")

  attemptedAt DateTime @default(now()) @map("attempted_at")

  @@index([deviceId, attemptedAt])
  @@index([ipAddress, attemptedAt])
  @@map("login_attempts")
}
