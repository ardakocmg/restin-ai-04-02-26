// ADD THESE TO THE MAIN schema.prisma FILE
// This file is for reference - merge into schema.prisma

// ============================================
// SHIFT MANAGEMENT & ACCESS CONTROL
// ============================================

model Shift {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  venueId   String   @map("venue_id")
  venue     Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)
  
  startAt   DateTime @map("start_at")
  endAt     DateTime @map("end_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([userId])
  @@index([venueId])
  @@index([startAt, endAt])
  @@map("shifts")
}

model VenueShiftPolicy {
  id               String   @id @default(uuid())
  venueId          String   @unique @map("venue_id")
  venue            Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)
  
  enforceShiftLogin Boolean @default(true) @map("enforce_shift_login")
  graceBefore       Int     @default(15)    // minutes before shift start
  graceAfter        Int     @default(30)    // minutes after shift end
  autoLogout        Boolean @default(true)  @map("auto_logout")
  
  allowManagerOverride  Boolean @default(true) @map("allow_manager_override")
  overrideDefaultMinutes Int    @default(15)  @map("override_default_minutes")
  overrideMaxMinutes     Int    @default(30)  @map("override_max_minutes")
  requireOverrideReason  Boolean @default(true) @map("require_override_reason")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("venue_shift_policies")
}

model ShiftOverride {
  id            String   @id @default(uuid())
  venueId       String   @map("venue_id")
  
  staffUserId   String   @map("staff_user_id")
  grantedByUserId String @map("granted_by_user_id")
  
  reason        String?
  startsAt      DateTime @map("starts_at")
  expiresAt     DateTime @map("expires_at")
  
  revokedAt     DateTime? @map("revoked_at")
  revokedByUserId String? @map("revoked_by_user_id")
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  @@index([staffUserId, venueId])
  @@index([startsAt, expiresAt])
  @@map("shift_overrides")
}

// ============================================
// AUTH SESSIONS & RATE LIMITING
// ============================================

model AuthSession {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  venueId     String    @map("venue_id")
  deviceId    String?   @map("device_id")
  app         String    // admin, pos, kds
  
  tokenHash   String    @map("token_hash")
  expiresAt   DateTime  @map("expires_at")
  revokedAt   DateTime? @map("revoked_at")
  
  createdAt   DateTime  @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("auth_sessions")
}

model LoginAttempt {
  id          String   @id @default(uuid())
  username    String?
  pin         String?  // last 2 digits for audit
  deviceId    String?  @map("device_id")
  ipAddress   String?  @map("ip_address")
  
  app         String   // admin, pos, kds
  success     Boolean
  failReason  String?  @map("fail_reason")
  
  userId      String?  @map("user_id")
  venueId     String?  @map("venue_id")
  
  attemptedAt DateTime @default(now()) @map("attempted_at")
  
  @@index([deviceId, attemptedAt])
  @@index([ipAddress, attemptedAt])
  @@map("login_attempts")
}

// ============================================
// UPDATE EXISTING MODELS
// ============================================

// Add to User model:
// allowedVenueIds String[]  @default([]) @map("allowed_venue_ids")
// defaultVenueId  String?   @map("default_venue_id")
// shifts          Shift[]

// Add to Venue model:
// shifts          Shift[]
// shiftPolicy     VenueShiftPolicy?
