// ðŸ—ï¸ ANTIGRAVITY MASTER SCHEMA (THE OMNISCIENT)
// Protocol v30.0 - The DNA of the Enterprise OS (MongoDB Production)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ==================================================================================
// 1. MULTI-TENANCY CORE (Rule #13 & #21)
// Hierarchy: Organization -> Brand -> Branch -> Device
// ==================================================================================

enum PlanType {
  BASIC
  STARTER
  PRO
  ENTERPRISE
}

enum Role {
  STAFF
  MANAGER
  ADMIN
  SUPER_ADMIN
}

enum DeviceType {
  POS_TERMINAL
  KITCHEN_DISPLAY
  WAITER_TABLET
  KIOSK
}

enum DeviceStatus {
  ONLINE
  OFFLINE
  MAINTENANCE
}

model Organization {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String   @unique
  plan        PlanType @default(BASIC)
  
  brands      Brand[]
  users       User[]
  auditLogs   AuditLog[]
  settings    SystemSetting?
  
  suppliers   Supplier[]
  ingredients Ingredient[]
  recipes     Recipe[]
  menus       Menu[]
  taxRules    TaxRule[]

  // ==================================================================================
  // MASTER PROTOCOL v30.0 RELATIONS
  // ==================================================================================
  
  // Pillar 0: Commercial
  subscriptionPlanId String? @db.ObjectId
  subscriptionPlan   SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  moduleConfig       ModuleConfig?
  
  // Use billingHistory to track all bills. Latest one is current.
  billingHistory     TenantBilling[] @relation("BillingHistory") 
  
  aiBrokerConfig     AiBrokerConfig?

  // Pillar 1: AI Config
  aiConfig           AiConfig?
  aiUsageLogs        AiUsageLog[]

  // Pillar 2: Web
  marketingSite      MarketingSite?
  
  // Pillar 3: CRM (Autopilot)
  customerProfiles   CustomerProfile[]
  marketingCampaigns MarketingCampaign[]

  // Pillar 4: Voice
  voiceConfig        VoiceConfig?
  callLogs           CallLog[]

  // Pillar 5: Studio
  brandIdentity      BrandIdentity?
  mediaAssets        MediaAsset[]

  // Pillar 6: Radar
  competitors        Competitor[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("organizations")
}

model Brand {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  
  branches       Branch[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@map("brands")
}

model Branch {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  brandId        String       @db.ObjectId
  brand          Brand        @relation(fields: [brandId], references: [id])
  
  name           String
  timezone       String       @default("Europe/Malta")
  currency       String       @default("EUR")
  
  devices        Device[]
  stockMovements StockMovement[]
  orders         Order[]
  fiscalDrifts   FiscalDrift[]
  stockCounts    StockCount[]
  employeeShifts EmployeeShift[]
  laborMetrics   LaborMetric[]
  
  // Pillar 7: Hub
  aggregatorConfig AggregatorConfig?
  kioskConfig      KioskConfig?
  
  // Gap Filling Relations
  productionBatches ProductionBatch[]
  wasteLogs         WasteLog[]
  posSessions       POSSession[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([brandId])
  @@map("branches")
}

model Device {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  branchId       String       @db.ObjectId
  branch         Branch       @relation(fields: [branchId], references: [id])
  
  name           String
  type           DeviceType
  ipAddress      String?
  status         DeviceStatus  @default(ONLINE)
  
  lastHeartbeat  DateTime?

  @@index([branchId])
  @@map("devices")
}

model User {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  email          String?      @unique
  hashedPassword String?
  pin            String?
  
  firstName      String?
  lastName       String?
  
  isAnonymized   Boolean      @default(false)
  anonymizedAt   DateTime?
  
  role           Role         @default(STAFF)
  permissions    String[]     
  
  staffProfile   StaffProfile?
  
  orders         Order[]
  movements      StockMovement[]
  stockCounts    StockCount[]
  shifts         EmployeeShift[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@map("users")
}

model StaffProfile {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String   @unique @db.ObjectId
  user           User     @relation(fields: [userId], references: [id])
  
  xpPoints       Int      @default(0)
  currentLevel   Int      @default(1)
  
  dailyQuestStatus Json? 
  badges         String[]
  
  updatedAt      DateTime @updatedAt
  
  @@map("staff_profiles")
}

model Supplier {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  email          String?
  phone          String?
  skuPrefix      String?
  
  ingredients    Ingredient[]
  
  @@index([organizationId])
  @@map("suppliers")
}

model Ingredient {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  supplierId     String?      @db.ObjectId
  supplier       Supplier?    @relation(fields: [supplierId], references: [id])
  
  supplierSku    String?
  
  purchaseUnit   String
  stockUnit      String
  conversionRate Float
  priceCents     Int
  
  wastagePercent Float        @default(0.0)
  nutritionalInfo Json?
  
  recipeItems    RecipeItem[]
  movements      StockMovement[]
  stockCountItems StockCountItem[]
  
  @@index([organizationId])
  @@map("ingredients")
}

enum RecipeType {
  PREP
  DISH
  MENU_ITEM
}

model Recipe {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  type           RecipeType   @default(PREP)
  
  items          RecipeItem[]
  
  menuItem       MenuItem?
  
  costCents      Int          @default(0)
  
  calories       Int?     
  protein        Float?   
  carbs          Float?   
  fat            Float?   
  allergens      String[] 
  
  rawImportData  Json?    
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Link to Engineering Data (Two-Tier Architecture)
  engineeredId   String?      @unique @db.ObjectId
  engineered     RecipeEngineered? @relation(fields: [engineeredId], references: [id])

  @@index([organizationId])
  @@map("recipes")
}

model RecipeEngineered {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  
  // Apicbase / External Data
  name           String       @map("recipe_name")
  sku            String?      @map("item_id")
  
  category       String?
  subcategory    String?
  active         Boolean      @default(true)

  // Production Details
  instructions   String?
  yield          Float?       @map("servings") // Approximate mapping or add new field
  laborTime      Int?
  
  // Full raw data for reference
  rawImportData  Json?
  externalLinks  Json?
  
  // Link back to Operational Recipe
  operationalRecipe Recipe?
  
  // Relation to Production
  productionBatches ProductionBatch[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@map("recipes_engineered")
}

model RecipeItem {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  
  parentRecipeId String       @db.ObjectId
  parentRecipe   Recipe       @relation(fields: [parentRecipeId], references: [id])
  
  ingredientId   String?      @db.ObjectId
  ingredient     Ingredient?  @relation(fields: [ingredientId], references: [id])
  
  subRecipeId    String?      @db.ObjectId
  
  quantity       Float
  unit           String
  
  @@index([parentRecipeId])
  @@map("recipe_items")
}

model Menu {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  isActive       Boolean      @default(true)
  
  categories     Category[]
  
  @@index([organizationId])
  @@map("menus")
}

model Category {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  menuId         String       @db.ObjectId
  menu           Menu         @relation(fields: [menuId], references: [id])
  
  name           String
  sortOrder      Int          @default(0)
  
  items          MenuItem[]
  
  @@index([menuId])
  @@map("categories")
}

model MenuItem {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  categoryId     String       @db.ObjectId
  category       Category     @relation(fields: [categoryId], references: [id])
  
  name           String
  recipeId       String?      @unique @db.ObjectId
  recipe         Recipe?      @relation(fields: [recipeId], references: [id])
  
  priceCents     Int
  taxRuleId      String?      @db.ObjectId
  taxRule        TaxRule?     @relation(fields: [taxRuleId], references: [id])
  
  orderItems     OrderItem[]

  @@index([categoryId])
  @@map("menu_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  SERVED
  PAID
  CANCELLED
}

model Order {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  branchId       String       @db.ObjectId
  branch         Branch       @relation(fields: [branchId], references: [id])
  
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id])
  
  status         OrderStatus
  
  totalCents     Int
  taxCents       Int
  
  items          OrderItem[]
  transaction    Transaction?
  
  fiscalHash     String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([branchId])
  @@map("orders")
}

model OrderItem {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  orderId        String       @db.ObjectId
  order          Order        @relation(fields: [orderId], references: [id])
  
  menuItemId     String       @db.ObjectId
  menuItem       MenuItem     @relation(fields: [menuItemId], references: [id])
  
  quantity       Int
  priceCents     Int
  
  @@index([orderId])
  @@map("order_items")
}

model TaxRule {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  rate           Float
  code           String
  
  effectiveDate  DateTime     @default(now())
  version        Int          @default(1)
  
  menuItems      MenuItem[]

  @@index([organizationId])
  @@map("tax_rules")
}

model FiscalDrift {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  branchId          String   @db.ObjectId
  branch            Branch   @relation(fields: [branchId], references: [id])

  fiscalPeriod      String
  theoreticalTax    Int
  actualTax         Int
  driftCents        Int
  driftPercentage   Float
  
  status            String   @default("PENDING")
  details           Json?

  createdAt         DateTime @default(now())

  @@index([branchId])
  @@map("fiscal_drifts")
}

model AuditLog {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  action         String
  entityType     String
  entityId       String
  
  userId         String?      @db.ObjectId
  
  oldValue       Json?
  newValue       Json?
  
  geoLat         Float?
  geoLong        Float?
  ipAddress      String?
  
  retentionDate  DateTime?
  isSystemAction Boolean      @default(false)
  piiScrubbed    Boolean      @default(false)

  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([entityId])
  @@map("audit_logs")
}

model SystemSetting {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @unique @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  config         Json
  
  version        Int          @default(1)
  environment    String       @default("production")
  lastPublished  DateTime?
  
  updatedAt      DateTime     @updatedAt

  @@map("system_settings")
}

model StockMovement {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  branchId       String       @db.ObjectId
  branch         Branch       @relation(fields: [branchId], references: [id])
  
  ingredientId   String       @db.ObjectId
  ingredient     Ingredient   @relation(fields: [ingredientId], references: [id])
  
  quantity       Float
  type           String
  reason         String?
  
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id])
  
  createdAt      DateTime     @default(now())

  @@index([branchId])
  @@index([ingredientId])
  @@map("stock_movements")
}

model StockCount {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  branchId       String           @db.ObjectId
  branch         Branch           @relation(fields: [branchId], references: [id])
  
  status         String           @default("DRAFT")
  performedById  String           @db.ObjectId
  performedBy    User             @relation(fields: [performedById], references: [id])
  
  items          StockCountItem[]
  
  startedAt      DateTime         @default(now())
  completedAt    DateTime?
  
  @@index([branchId])
  @@map("stock_counts")
}

model StockCountItem {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  stockCountId   String       @db.ObjectId
  stockCount     StockCount   @relation(fields: [stockCountId], references: [id])
  
  ingredientId   String       @db.ObjectId
  ingredient     Ingredient   @relation(fields: [ingredientId], references: [id])
  
  expectedBase   Float
  actualBase     Float
  variance       Float
  
  costImpact     Int?
  
  @@index([stockCountId])
  @@map("stock_count_items")
}

// ==================================================================================
// PILLAR 0: COMMERCIAL ENGINE (Billing & Brokerage)
// ==================================================================================

model SubscriptionPlan {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique 
  basePrice   Float    @default(0.0) // Float for MongoDB compatibility
  currency    String   @default("EUR")
  
  features    Json     
  limits      Json?    
  
  tenants     Organization[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("subscription_plans")
}

model ModuleConfig {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @unique @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  hasVoice       Boolean      @default(false)
  hasRadar       Boolean      @default(false)
  hasStudio      Boolean      @default(false)
  hasWeb         Boolean      @default(false)
  hasCrm         Boolean      @default(false)
  
  customMonthlyPrice Float? // Float for MongoDB compatibility
  
  updatedAt      DateTime     @updatedAt

  @@map("module_configs")
}

enum AIProvider {
  GOOGLE
  OPENAI
  ELEVENLABS
}

model AiBrokerConfig {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String?      @unique @db.ObjectId 
  organization   Organization? @relation(fields: [organizationId], references: [id])

  provider       AIProvider
  model          String
  
  costPerUnit    Float      // Float for MongoDB compatibility
  sellPricePerUnit Float    // Float for MongoDB compatibility
  
  unitType       String       @default("TOKEN") 
  
  isActive       Boolean      @default(true)
  
  @@map("ai_broker_configs")
}

model TenantBilling {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId 
  organization   Organization @relation("BillingHistory", fields: [organizationId], references: [id])
  
  periodStart    DateTime
  periodEnd      DateTime
  
  subscriptionFee Float // Float for MongoDB compatibility
  moduleFees      Float
  aiUsageFee      Float
  storageFee      Float
  
  totalDue        Float
  
  storageUsedMB   Float      @default(0.0)
  vectorCount     Int        @default(0)
  
  status          String      
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([organizationId])
  @@map("tenant_billings")
}

// ==================================================================================
// PILLAR 1: AI INFRASTRUCTURE (Google First)
// ==================================================================================

model AiConfig {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @unique @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  activeModel    String       @default("gemini-1.5-flash")
  groundingEnabled Boolean    @default(true)
  
  updatedAt      DateTime     @updatedAt
  @@map("ai_configs")
}

model AiUsageLog {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  modelUsed      String
  inputTokens    Int
  outputTokens   Int
  totalTokens    Int
  
  costCents      Float // Float for MongoDB compatibility
  priceCents     Float
  profitCents    Float
  
  feature        String    
  
  timestamp      DateTime     @default(now())
  
  @@index([organizationId])
  @@map("ai_usage_logs")
}

model GoogleGrounding {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  query       String   @unique
  result      Json
  source      String   
  
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  
  @@map("google_groundings")
}

// ==================================================================================
// PILLAR 2: WEB ARCHITECT (Digital Storefront)
// ==================================================================================

model MarketingSite {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @unique @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  domain         String?
  themeConfig    Json?
  seoConfig      Json?
  
  sections       WebSection[]
  
  isPublished    Boolean      @default(false)
  publishedAt    DateTime?
  
  updatedAt      DateTime     @updatedAt
  
  @@map("marketing_sites")
}

model WebSection {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  siteId         String        @db.ObjectId
  site           MarketingSite @relation(fields: [siteId], references: [id])
  
  type           String
  content        Json
  sortOrder      Int           @default(0)
  
  linkedCategoryId String?
  
  updatedAt      DateTime      @updatedAt
  
  @@index([siteId])
  @@map("web_sections")
}

// ==================================================================================
// PILLAR 3: AUTOPILOT CRM
// ==================================================================================

model CustomerProfile {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  phone          String?
  email          String?
  name           String?
  
  churnScore     Float        @default(0.0)
  tasteTags      String[]
  
  lastVisit      DateTime?
  visitCount     Int          @default(0)
  totalSpent     Float        @default(0.0) // Float for MongoDB compatibility
  
  // Explicit M:N using ID Arrays for MongoDB
  campaignIDs    String[]     @db.ObjectId
  campaigns      MarketingCampaign[] @relation(fields: [campaignIDs], references: [id])
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@unique([organizationId, phone])
  @@index([churnScore])
  @@map("customer_profiles")
}

model MarketingCampaign {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  type           String
  status         String
  
  targetSegment  Json?
  
  aiGeneratedContent String?
  
  sentCount      Int          @default(0)
  clickCount     Int          @default(0)
  
  // Explicit M:N using ID Arrays for MongoDB
  customerIDs    String[]     @db.ObjectId
  customers      CustomerProfile[] @relation(fields: [customerIDs], references: [id])
  
  createdAt      DateTime     @default(now())
  
  @@map("marketing_campaigns")
}

// ==================================================================================
// PILLAR 4: VOICE AI
// ==================================================================================

model VoiceConfig {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @unique @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  persona        String       @default("PROFESSIONAL")
  knowledgeBase  String[]     
  
  isEnabled      Boolean      @default(false)
  forwardNumber  String?
  
  updatedAt      DateTime     @updatedAt
  
  @@map("voice_configs")
}

model CallLog {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  callerNumber   String?
  durationSeconds Int
  summary        String?
  actionTaken    String?
  sentiment      String?      
  
  costCents      Int
  
  createdAt      DateTime     @default(now())
  
  @@index([organizationId])
  @@map("call_logs")
}

// ==================================================================================
// PILLAR 5: THE STUDIO
// ==================================================================================

model BrandIdentity {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @unique @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  visualStyle    String?
  toneOfVoice    String?
  colorPalette   String[]
  
  updatedAt      DateTime     @updatedAt
  
  @@map("brand_identities")
}

enum MediaSource {
  REAL
  GENERATED
}

model MediaAsset {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  url            String
  type           String
  source         MediaSource  @default(REAL)
  
  tags           String[]
  
  createdAt      DateTime     @default(now())
  
  @@index([organizationId])
  @@map("media_assets")
}

// ==================================================================================
// PILLAR 6: DEEP INTELLIGENCE (Radar)
// ==================================================================================

model Competitor {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  googlePlaceId  String?
  
  trackedProducts Json?
  lastScrapedAt  DateTime?
  
  @@index([organizationId])
  @@map("competitors")
}

// ==================================================================================
// PILLAR 7: HUB & AGGREGATOR & OPS
// ==================================================================================

model AggregatorConfig {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  branchId       String       @unique @db.ObjectId
  branch         Branch       @relation(fields: [branchId], references: [id])
  
  uberEatsKey    String?
  woltKey        String?
  boltFoodKey    String?
  
  isEnabled      Boolean      @default(false)
  autoAccept     Boolean      @default(true)
  
  updatedAt      DateTime     @updatedAt
  
  @@map("aggregator_configs")
}

model EmployeeShift {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  branchId       String       @db.ObjectId
  branch         Branch       @relation(fields: [branchId], references: [id])
  
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id])
  
  startTime      DateTime
  endTime        DateTime?
  
  role           String
  
  createdAt      DateTime     @default(now())
  
  @@index([branchId])
  @@map("employee_shifts")
}

model LaborMetric {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  branchId       String       @db.ObjectId
  branch         Branch       @relation(fields: [branchId], references: [id])
  
  date           DateTime
  totalLaborCost Float // Float for MongoDB compatibility
  laborPercentage Float
  
  salesTotal     Float // Float for MongoDB compatibility
  
  calculatedAt   DateTime     @default(now())
  
  @@index([branchId])
  @@map("labor_metrics")
}

// ==================================================================================
// PILLAR 8: THE FINTECH (Omni-Payment)
// ==================================================================================

model KioskConfig {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  branchId       String   @unique @db.ObjectId
  branch         Branch   @relation(fields: [branchId], references: [id])
  
  isKioskMode    Boolean  @default(false)
  welcomeMessage String?
  autoPrintReceipt Boolean @default(true)
  
  updatedAt      DateTime @updatedAt
  
  @@map("kiosk_configs")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentMethod {
  CASH
  CARD
  WALLET
}

model Transaction {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId        String   @unique @db.ObjectId
  order          Order    @relation(fields: [orderId], references: [id])
  
  amountCents    Int
  paymentMethod  PaymentMethod
  status         PaymentStatus
  
  provider       String?  
  externalRef    String?  @unique
  
  createdAt      DateTime @default(now())
  
  @@map("transactions")
}

// ==================================================================================
// GAP FILLING: PRODUCTION & WASTE
// ==================================================================================

enum ProductionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model ProductionBatch {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  venueId        String       @db.ObjectId
  venue          Branch       @relation(fields: [venueId], references: [id])
  
  recipeId       String       @db.ObjectId
  recipe         RecipeEngineered @relation(fields: [recipeId], references: [id])
  
  batchNumber    String
  status         ProductionStatus @default(PLANNED)
  
  plannedQuantity Float
  actualQuantity  Float?
  unit           String
  
  startDate      DateTime?
  endDate        DateTime?
  
  producedBy     String?      @db.ObjectId // User ID
  
  notes          String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@index([venueId])
  @@map("production_batches")
}

model WasteLog {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  venueId        String       @db.ObjectId
  venue          Branch       @relation(fields: [venueId], references: [id])
  
  itemId         String?      @db.ObjectId // Can be Ingredient or Recipe
  itemName       String
  itemType       String       // "INGREDIENT" or "RECIPE"
  
  quantity       Float
  unit           String
  costCents      Int
  
  reason         String
  notes          String?
  
  reportedBy     String       @db.ObjectId // User ID
  
  createdAt      DateTime     @default(now())
  
  @@index([venueId])
  @@map("waste_logs")
}

// ==================================================================================
// GAP FILLING: POS SESSIONS
// ==================================================================================

enum SessionStatus {
  OPEN
  CLOSED
}

model POSSession {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  venueId        String       @db.ObjectId
  venue          Branch       @relation(fields: [venueId], references: [id])
  
  stationId      String?      @db.ObjectId // If tied to specific device
  stationName    String?
  
  openedBy       String       @db.ObjectId
  closedBy       String?      @db.ObjectId
  
  openingTime    DateTime     @default(now())
  closingTime    DateTime?
  
  status         SessionStatus @default(OPEN)
  
  openingBalanceCents Int     @default(0)
  closingBalanceCents Int?
  
  cashSalesCents      Int     @default(0)
  cardSalesCents      Int     @default(0)
  totalSalesCents     Int     @default(0)
  
  cashDifferenceCents Int?    // Overage/Shortage
  
  notes               String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@index([venueId])
  @@map("pos_sessions")
}
