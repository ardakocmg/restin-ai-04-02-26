// ðŸ—ï¸ ANTIGRAVITY MASTER SCHEMA (THE OMNISCIENT)
// Protocol v17.0 - The DNA of the Enterprise OS

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==================================================================================
// 1. MULTI-TENANCY CORE (Rule #13 & #21)
// Hierarchy: Organization -> Brand -> Branch -> Device
// ==================================================================================

// SQLite Compatibility: Enums removed

model Organization {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  plan        String   @default("BASIC") // SQLite: String
  
  brands      Brand[]
  users       User[]
  auditLogs   AuditLog[]
  settings    SystemSetting?
  
  suppliers   Supplier[]
  ingredients Ingredient[]
  recipes     Recipe[]
  menus       Menu[]
  taxRules    TaxRule[]

  // ==================================================================================
  // MASTER PROTOCOL v18.0 RELATIONS
  // ==================================================================================
  
  // Pillar 0: Commercial
  subscriptionPlanId String?
  subscriptionPlan   SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  moduleConfig       ModuleConfig?
  storageBilling     StorageBilling?

  // Pillar 2: Web
  marketingSite      MarketingSite?
  
  // Pillar 3: CRM (Autopilot)
  customerProfiles   CustomerProfile[]
  marketingCampaigns MarketingCampaign[]

  // Pillar 4: Voice
  voiceConfig        VoiceConfig?
  callLogs           CallLog[]

  // Pillar 5: Studio
  brandIdentity      BrandIdentity?
  mediaAssets        MediaAsset[]

  // Pillar 6: Radar
  competitors        Competitor[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Brand {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  branches       Branch[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
}

model Branch {
  id             String       @id @default(uuid())
  brandId        String
  brand          Brand        @relation(fields: [brandId], references: [id])
  
  name           String
  timezone       String       @default("Europe/Malta")
  currency       String       @default("EUR")
  
  devices        Device[]
  stockMovements StockMovement[]
  orders         Order[]
  fiscalDrifts   FiscalDrift[]
  stockCounts    StockCount[]
  
  // Pillar 7: Hub
  aggregatorConfig AggregatorConfig?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([brandId])
}

model Device {
  id             String   @id @default(uuid())
  branchId       String
  branch         Branch   @relation(fields: [branchId], references: [id])
  
  name           String
  type           String   // SQLite: String (POS_TERMINAL, etc)
  ipAddress      String?
  status         String   @default("ONLINE")
  
  lastHeartbeat  DateTime?
  
  @@index([branchId])
}

model User {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  email          String?      @unique
  hashedPassword String?
  pin            String?
  
  firstName      String?
  lastName       String?
  
  isAnonymized   Boolean      @default(false)
  anonymizedAt   DateTime?
  
  role           String       @default("STAFF") // SQLite: String (SUPER_ADMIN, etc)
  permissions    String // SQLite: JSON string or similar? No, Prisma supports String[] on Postgres but SQLite?
  // Prisma SQLite DOES NOT support scalar lists (String[]).
  // I must change permissions to String (JSON serialized) or standard String with separator.
  // Wait, Prisma docs say "Scalar lists are not supported in SQLite".
  
  staffProfile   StaffProfile?
  
  orders         Order[]
  movements      StockMovement[]
  stockCounts    StockCount[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([email])
}

// ... wait, permissions String[] failure will likely happen too.
// I will attempt simple fixes first.

model StaffProfile {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  
  xpPoints       Int      @default(0)
  currentLevel   Int      @default(1)
  
  dailyQuestStatus String?   // SQLite: Store as JSON-String if Json not fully supported? 
  // SQLite supports "Json" type via String in Prisma? Prisma supports Json type in SQLite? Yes.
  // But String[] (badges) is NOT supported.
  badges         String    @default("[]") // SQLite Hack: JSON String
  
  updatedAt      DateTime @updatedAt
}

model Supplier {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  email          String?
  phone          String?
  skuPrefix      String?
  
  ingredients    Ingredient[]
  
  @@index([organizationId])
}

model Ingredient {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  supplierId     String?
  supplier       Supplier?    @relation(fields: [supplierId], references: [id])
  
  supplierSku    String?
  
  purchaseUnit   String
  stockUnit      String
  conversionRate Float
  priceCents     Int
  
  wastagePercent Float        @default(0.0)
  nutritionalInfo String?     // SQLite: JSON String (was Json)
  
  recipeItems    RecipeItem[]
  movements      StockMovement[]
  stockCountItems StockCountItem[]
  
  @@index([organizationId])
}

model Recipe {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  type           String       @default("PREP") // SQLite: String
  
  items          RecipeItem[]
  
  menuItem       MenuItem?
  
  costCents      Int          @default(0)
  
  // Rule #40 (Apicbase Parity) - Nutrition
  calories       Int?     // kcal
  protein        Float?   // grams
  carbs          Float?   // grams
  fat            Float?   // grams
  allergens      String?  // JSON Array
  
  @@index([organizationId])
}

model RecipeItem {
  id             String       @id @default(uuid())
  
  parentRecipeId String
  parentRecipe   Recipe       @relation(fields: [parentRecipeId], references: [id])
  
  ingredientId   String?
  ingredient     Ingredient?  @relation(fields: [ingredientId], references: [id])
  
  subRecipeId    String?
  
  quantity       Float
  unit           String
  
  @@index([parentRecipeId])
}

model Menu {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  isActive       Boolean      @default(true)
  
  categories     Category[]
  
  @@index([organizationId])
}

model Category {
  id             String       @id @default(uuid())
  menuId         String
  menu           Menu         @relation(fields: [menuId], references: [id])
  
  name           String
  sortOrder      Int          @default(0)
  
  items          MenuItem[]
  
  @@index([menuId])
}

model MenuItem {
  id             String       @id @default(uuid())
  categoryId     String
  category       Category     @relation(fields: [categoryId], references: [id])
  
  name           String
  recipeId       String?      @unique
  recipe         Recipe?      @relation(fields: [recipeId], references: [id])
  
  priceCents     Int
  taxRuleId      String?
  taxRule        TaxRule?     @relation(fields: [taxRuleId], references: [id])
  
  orderItems     OrderItem[]

  @@index([categoryId])
}

model Order {
  id             String       @id @default(uuid())
  branchId       String
  branch         Branch       @relation(fields: [branchId], references: [id])
  
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  
  status         String
  
  totalCents     Int
  taxCents       Int
  
  items          OrderItem[]
  
  fiscalHash     String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([branchId])
}

model OrderItem {
  id             String       @id @default(uuid())
  orderId        String
  order          Order        @relation(fields: [orderId], references: [id])
  
  menuItemId     String
  menuItem       MenuItem     @relation(fields: [menuItemId], references: [id])
  
  quantity       Int
  priceCents     Int
  
  @@index([orderId])
}

model TaxRule {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  rate           Float
  code           String
  
  effectiveDate  DateTime     @default(now())
  version        Int          @default(1)
  
  menuItems      MenuItem[]

  @@index([organizationId])
}

model FiscalDrift {
  id                String   @id @default(uuid())
  branchId          String
  branch            Branch   @relation(fields: [branchId], references: [id])

  fiscalPeriod      String
  theoreticalTax    Int
  actualTax         Int
  driftCents        Int
  driftPercentage   Float
  
  status            String   @default("PENDING")
  details           String?  // SQLite: JSON String

  createdAt         DateTime @default(now())

  @@index([branchId])
}

model AuditLog {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  action         String
  entityType     String
  entityId       String
  
  userId         String?
  
  oldValue       String? // SQLite: JSON String
  newValue       String? // SQLite: JSON String
  
  geoLat         Float?
  geoLong        Float?
  ipAddress      String?
  
  retentionDate  DateTime?
  isSystemAction Boolean      @default(false)
  piiScrubbed    Boolean      @default(false)

  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([entityId])
}

model SystemSetting {
  id             String       @id @default(uuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  config         String       // SQLite: JSON String
  
  version        Int          @default(1)
  environment    String       @default("production")
  lastPublished  DateTime?
  
  updatedAt      DateTime     @updatedAt
}

model StockMovement {
  id             String       @id @default(uuid())
  branchId       String
  branch         Branch       @relation(fields: [branchId], references: [id])
  
  ingredientId   String
  ingredient     Ingredient   @relation(fields: [ingredientId], references: [id])
  
  quantity       Float
  type           String
  reason         String?
  
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  
  createdAt      DateTime     @default(now())

  @@index([branchId])
  @@index([ingredientId])
}

model StockCount {
  id             String           @id @default(uuid())
  branchId       String
  branch         Branch           @relation(fields: [branchId], references: [id])
  
  status         String           @default("DRAFT") // SQLite: String
  performedById  String
  performedBy    User             @relation(fields: [performedById], references: [id])
  
  items          StockCountItem[]
  
  startedAt      DateTime         @default(now())
  completedAt    DateTime?
  
  @@index([branchId])
}

model StockCountItem {
  id             String       @id @default(uuid())
  stockCountId   String
  stockCount     StockCount   @relation(fields: [stockCountId], references: [id])
  
  ingredientId   String
  ingredient     Ingredient   @relation(fields: [ingredientId], references: [id])
  
  expectedBase   Float
  actualBase     Float
  variance       Float
  
  costImpact     Int?
  
  @@index([stockCountId])
}

// ==================================================================================
// PILLAR 0: COMMERCIAL ENGINE (Billing & Brokerage)
// ==================================================================================

model SubscriptionPlan {
  id          String   @id @default(uuid())
  name        String   @unique // "Starter", "Pro", "Enterprise"
  basePrice   Decimal  @default(0.0)
  currency    String   @default("EUR")
  
  features    String   // JSON List of active pillars/features
  limits      String?  // JSON Limits (e.g. maxTasks, maxUsers)
  
  tenants     Organization[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ModuleConfig {
  id             String       @id @default(uuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  // Feature Toggles
  hasVoice       Boolean      @default(false)
  hasRadar       Boolean      @default(false)
  hasStudio      Boolean      @default(false)
  hasWeb         Boolean      @default(false)
  hasCrm         Boolean      @default(false)
  
  // Custom Pricing Overrides
  customMonthlyPrice Decimal?
  
  updatedAt      DateTime     @updatedAt
}

model AiBrokerConfig {
  id             String       @id @default(uuid())
  provider       String       // "GOOGLE", "OPENAI", "ELEVENLABS"
  model          String       // "gemini-1.5-flash", "gpt-4o"
  
  costPerUnit    Decimal      // Our wholesale cost per 1k tokens
  sellPricePerUnit Decimal    // Tenant retail price per 1k tokens
  
  unitType       String       @default("TOKEN") // "TOKEN", "SECOND", "IMAGE"
  
  isActive       Boolean      @default(true)
}

model StorageBilling {
  id             String       @id @default(uuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  totalMediaSizeMB Float      @default(0.0)
  totalVectorCount Int        @default(0)
  
  usageHistory   String?      // JSON History
  
  updatedAt      DateTime     @updatedAt
}

// ==================================================================================
// PILLAR 1: AI INFRASTRUCTURE (Google First)
// ==================================================================================

model GoogleGrounding {
  id          String   @id @default(uuid())
  query       String   @unique
  result      String   // JSON Cached Result
  source      String   // "SEARCH", "MAPS"
  
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

// ==================================================================================
// PILLAR 2: WEB ARCHITECT (Digital Storefront)
// ==================================================================================

model MarketingSite {
  id             String       @id @default(uuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  domain         String?
  themeConfig    String?      // JSON Theme
  seoConfig      String?      // JSON SEO Tags
  
  sections       WebSection[]
  
  isPublished    Boolean      @default(false)
  publishedAt    DateTime?
  
  updatedAt      DateTime     @updatedAt
}

model WebSection {
  id             String        @id @default(uuid())
  siteId         String
  site           MarketingSite @relation(fields: [siteId], references: [id])
  
  type           String        // "HERO", "MENU", "TESTIMONIALS"
  content        String        // JSON Content
  sortOrder      Int           @default(0)
  
  // Link to Inventory
  linkedCategoryId String?
  
  updatedAt      DateTime      @updatedAt
  
  @@index([siteId])
}

// ==================================================================================
// PILLAR 3: AUTOPILOT CRM
// ==================================================================================

model CustomerProfile {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  phone          String?
  email          String?
  name           String?
  
  churnScore     Float        @default(0.0) // 0-100 High Risk
  tasteTags      String?      // JSON Array ["Spicy", "Vegan"]
  
  lastVisit      DateTime?
  visitCount     Int          @default(0)
  totalSpent     Decimal      @default(0.0)
  
  campaigns      MarketingCampaign[] // Many-to-Many ideally, simplified here
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@unique([organizationId, phone])
  @@index([churnScore])
}

model MarketingCampaign {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  type           String       // "SMS", "EMAIL"
  status         String       // "DRAFT", "SENT"
  
  targetSegment  String?      // JSON Logic
  
  aiGeneratedContent String?
  
  sentCount      Int          @default(0)
  clickCount     Int          @default(0)
  
  customers      CustomerProfile[]
  
  createdAt      DateTime     @default(now())
}

// ==================================================================================
// PILLAR 4: VOICE AI
// ==================================================================================

model VoiceConfig {
  id             String       @id @default(uuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  persona        String       @default("PROFESSIONAL") // "CASUAL", "BRITISH_BUTLER"
  knowledgeBase  String?      // JSON Array of PDF IDs
  
  isEnabled      Boolean      @default(false)
  forwardNumber  String?
  
  updatedAt      DateTime     @updatedAt
}

model CallLog {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  callerNumber   String?
  durationSeconds Int
  summary        String?
  actionTaken    String?      // "RESERVATION", "MENU_QUERY"
  
  costCents      Int          // Calculated from AiBroker
  
  createdAt      DateTime     @default(now())
  
  @@index([organizationId])
}

// ==================================================================================
// PILLAR 5: THE STUDIO
// ==================================================================================

model BrandIdentity {
  id             String       @id @default(uuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  visualStyle    String?      // "MINIMALIST", "RUSTIC"
  toneOfVoice    String?      // "WITTY", "FORMAL"
  colorPalette   String?      // JSON Array
  
  updatedAt      DateTime     @updatedAt
}

model MediaAsset {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  url            String
  type           String       // "IMAGE", "VIDEO"
  source         String       // "UPLOAD", "GENERATED"
  
  tags           String?      // JSON Array
  
  createdAt      DateTime     @default(now())
  
  @@index([organizationId])
}

// ==================================================================================
// PILLAR 6: DEEP INTELLIGENCE (Radar)
// ==================================================================================

model Competitor {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  name           String
  googlePlaceId  String?
  
  trackedProducts String?     // JSON (Burger -> Price)
  lastScrapedAt  DateTime?
  
  @@index([organizationId])
}

// ==================================================================================
// PILLAR 7: HUB & AGGREGATOR
// ==================================================================================

model AggregatorConfig {
  id             String       @id @default(uuid())
  branchId       String       @unique
  branch         Branch       @relation(fields: [branchId], references: [id])
  
  uberEatsKey    String?
  woltKey        String?
  boltFoodKey    String?
  
  isEnabled      Boolean      @default(false)
  autoAccept     Boolean      @default(true)
  
  updatedAt      DateTime     @updatedAt
}
